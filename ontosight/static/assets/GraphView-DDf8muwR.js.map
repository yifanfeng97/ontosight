{"version":3,"file":"GraphView-DDf8muwR.js","sources":["../../../frontend/src/components/views/GraphView.tsx"],"sourcesContent":["import { useEffect, useRef, useCallback, memo } from \"react\";\r\nimport * as G6 from \"@antv/g6\";\r\nimport { useVisualization } from \"@/hooks/useVisualization\";\r\nimport { useSearch } from \"@/hooks/useSearch\";\r\nimport { Tooltip, message } from \"antd\";\r\nimport \"@/components/views/GraphView.css\";\r\n\r\ninterface GraphViewProps {\r\n  data: any;\r\n  meta: any;\r\n}\r\n\r\nconst GraphView = memo(function GraphView({ data, meta }: GraphViewProps) {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const graphRef = useRef<any>(null);\r\n  const tooltipRef = useRef<HTMLDivElement>(null);\r\n  const { selectedNodes, selectNode, deselectNode, clearSelection } = useVisualization();\r\n  const { results: searchResults } = useSearch();\r\n\r\n  const handleNodeClick = useCallback(\r\n    (evt: any) => {\r\n      const nodeModel = evt.item;\r\n      if (!nodeModel) return;\r\n\r\n      const nodeId = nodeModel.get(\"id\");\r\n      if (selectedNodes.has(nodeId)) {\r\n        deselectNode(nodeId);\r\n      } else {\r\n        selectNode(nodeId);\r\n      }\r\n    },\r\n    [selectedNodes, selectNode, deselectNode]\r\n  );\r\n\r\n  const handleCanvasClick = useCallback(() => {\r\n    clearSelection();\r\n  }, [clearSelection]);\r\n\r\n  // 处理节点悬停时的 Tooltip\r\n  const handleNodeMouseEnter = useCallback((evt: any) => {\r\n    const nodeModel = evt.item;\r\n    if (!nodeModel || !tooltipRef.current) return;\r\n\r\n    const nodeData = nodeModel.getModel();\r\n    const { x, y } = nodeModel.getModel();\r\n    \r\n    // 构建 Tooltip 内容\r\n    const content = `\r\n      <div class=\"graph-node-tooltip\">\r\n        <div class=\"tooltip-title\">${nodeData.label || nodeData.id}</div>\r\n        <div class=\"tooltip-id\">ID: ${nodeData.id}</div>\r\n        ${nodeData.description ? `<div class=\"tooltip-desc\">${nodeData.description}</div>` : ''}\r\n        ${nodeData.value !== undefined ? `<div class=\"tooltip-value\">Value: ${nodeData.value}</div>` : ''}\r\n      </div>\r\n    `;\r\n\r\n    tooltipRef.current.innerHTML = content;\r\n    tooltipRef.current.style.display = 'block';\r\n    tooltipRef.current.style.left = (x ?? 0) + 10 + 'px';\r\n    tooltipRef.current.style.top = (y ?? 0) + 10 + 'px';\r\n  }, []);\r\n\r\n  const handleNodeMouseLeave = useCallback(() => {\r\n    if (tooltipRef.current) {\r\n      tooltipRef.current.style.display = 'none';\r\n    }\r\n  }, []);\r\n\r\n  // 键盘快捷键处理\r\n  const handleKeyDown = useCallback((evt: KeyboardEvent) => {\r\n    if (evt.key === 'Escape') {\r\n      clearSelection();\r\n    } else if ((evt.ctrlKey || evt.metaKey) && evt.key === 'f') {\r\n      evt.preventDefault();\r\n      message.info('搜索面板已激活');\r\n    } else if (evt.key === 'Delete' && selectedNodes.size > 0) {\r\n      selectedNodes.forEach((nodeId) => {\r\n        deselectNode(nodeId);\r\n      });\r\n      message.success('已清除选中节点');\r\n    }\r\n  }, [selectedNodes, clearSelection, deselectNode]);\r\n\r\n  // 高亮搜索结果\r\n  const highlightSearchResults = useCallback((graph: any) => {\r\n    if (!graph) return;\r\n\r\n    const allNodes = (graph as any).getNodes();\r\n    const searchResultSet = new Set(searchResults);\r\n\r\n    allNodes.forEach((node: any) => {\r\n      const nodeId = node.getID();\r\n      if (searchResultSet.has(nodeId)) {\r\n        node.toFront();\r\n        (graph as any).setItemState(node, 'highlight', true);\r\n      } else {\r\n        (graph as any).setItemState(node, 'highlight', false);\r\n      }\r\n    });\r\n\r\n    // 如果有搜索结果，聚焦到第一个\r\n    if (searchResults.length > 0) {\r\n      const firstResult = (graph as any).findById(searchResults[0]);\r\n      if (firstResult) {\r\n        (graph as any).focusItem(firstResult, true);\r\n      }\r\n    }\r\n  }, [searchResults]);\r\n\r\n  useEffect(() => {\r\n    if (!containerRef.current || !data.nodes) return;\r\n\r\n    // Clean up old graph\r\n    if (graphRef.current) {\r\n      graphRef.current.destroy();\r\n    }\r\n\r\n    // 注册自定义节点状态样式\r\n    if (!(G6 as any).registered('highlight')) {\r\n      (G6 as any).registerBehavior('highlight', {\r\n        getEvents() {\r\n          return {\r\n            'node:mouseenter': 'onNodeEnter',\r\n            'node:mouseleave': 'onNodeLeave',\r\n          };\r\n        },\r\n        onNodeEnter(evt: any) {\r\n          const { item } = evt;\r\n          (this.graph as any).setItemState(item, 'highlight', true);\r\n        },\r\n        onNodeLeave(evt: any) {\r\n          const { item } = evt;\r\n          (this.graph as any).setItemState(item, 'highlight', false);\r\n        },\r\n      });\r\n    }\r\n\r\n    // Create new graph\r\n    const graph = new (G6 as any).Graph({\r\n      container: containerRef.current,\r\n      width: containerRef.current.clientWidth,\r\n      height: containerRef.current.clientHeight,\r\n      modes: {\r\n        default: [\"drag-canvas\", \"zoom-canvas\", \"drag-node\"],\r\n      },\r\n      nodeStateStyles: {\r\n        highlight: {\r\n          fill: '#ffd666',\r\n          stroke: '#faad14',\r\n          lineWidth: 2,\r\n          shadowColor: '#faad14',\r\n          shadowBlur: 10,\r\n        },\r\n        selected: {\r\n          fill: '#1890ff',\r\n          stroke: '#1890ff',\r\n          lineWidth: 3,\r\n          shadowColor: '#1890ff',\r\n          shadowBlur: 10,\r\n        },\r\n      },\r\n      edgeStateStyles: {\r\n        highlight: {\r\n          stroke: '#faad14',\r\n          lineWidth: 2,\r\n          opacity: 1,\r\n        },\r\n      },\r\n    });\r\n\r\n    // Add data\r\n    (graph as any).data({\r\n      nodes: data.nodes.map((node: any) => ({\r\n        ...node,\r\n        size: 30,\r\n        style: {\r\n          fill: selectedNodes.has(node.id) ? \"#1890ff\" : \"#87d068\",\r\n          lineWidth: selectedNodes.has(node.id) ? 3 : 1,\r\n          stroke: selectedNodes.has(node.id) ? \"#1890ff\" : \"#666\",\r\n        },\r\n      })),\r\n      edges: (data.edges || []).map((edge: any) => ({\r\n        ...edge,\r\n        style: {\r\n          stroke: '#ccc',\r\n          lineWidth: 1,\r\n        },\r\n      })),\r\n    });\r\n\r\n    // Event handlers\r\n    graph.on(\"node:click\", handleNodeClick);\r\n    graph.on(\"canvas:click\", handleCanvasClick);\r\n    graph.on(\"node:mouseenter\", handleNodeMouseEnter);\r\n    graph.on(\"node:mouseleave\", handleNodeMouseLeave);\r\n\r\n    // 双击节点展开相邻节点\r\n    graph.on(\"node:dblclick\", (evt: any) => {\r\n      const nodeModel = evt.item;\r\n      if (!nodeModel) return;\r\n      const neighbors = (graph as any).getNeighbors(nodeModel);\r\n      neighbors.forEach((neighbor: any) => {\r\n        (graph as any).setItemState(neighbor, 'highlight', true);\r\n      });\r\n    });\r\n\r\n    // Render\r\n    graph.render();\r\n\r\n    // 应用搜索高亮\r\n    highlightSearchResults(graph);\r\n\r\n    // Handle resize\r\n    const handleResize = () => {\r\n      if (containerRef.current) {\r\n        (graph as any).changeSize(\r\n          containerRef.current.clientWidth,\r\n          containerRef.current.clientHeight\r\n        );\r\n      }\r\n    };\r\n\r\n    window.addEventListener(\"resize\", handleResize);\r\n    window.addEventListener(\"keydown\", handleKeyDown);\r\n    graphRef.current = graph;\r\n\r\n    return () => {\r\n      window.removeEventListener(\"resize\", handleResize);\r\n      window.removeEventListener(\"keydown\", handleKeyDown);\r\n      graph.destroy();\r\n    };\r\n  }, [data, selectedNodes, handleNodeClick, handleCanvasClick, handleNodeMouseEnter, handleNodeMouseLeave, handleKeyDown, highlightSearchResults]);\r\n\r\n  return (\r\n    <div style={{ position: 'relative', width: '100%', height: '100%' }}>\r\n      <div ref={containerRef} className=\"graph-view\" />\r\n      <div\r\n        ref={tooltipRef}\r\n        className=\"graph-tooltip\"\r\n        style={{ display: 'none' }}\r\n      />\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default GraphView;\r\n"],"names":["GraphView","memo","data","meta","containerRef","useRef","graphRef","tooltipRef","selectedNodes","selectNode","deselectNode","clearSelection","useVisualization","searchResults","useSearch","handleNodeClick","useCallback","evt","nodeModel","nodeId","handleCanvasClick","handleNodeMouseEnter","nodeData","x","y","content","handleNodeMouseLeave","handleKeyDown","message","highlightSearchResults","graph","allNodes","searchResultSet","node","firstResult","useEffect","G6.registered","G6.registerBehavior","item","G6.Graph","edge","neighbor","handleResize","jsxs","jsx"],"mappings":"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"}