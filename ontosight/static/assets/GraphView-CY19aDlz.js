import{r as c,u as D,a as L,b as $,j as b}from"./index-Cgw79int.js";import{G as K,N as p,C as T}from"./preset-BE72H_a1.js";function H(m){const l=new Map;return m.forEach(s=>{const o=s.source<s.target?`${s.source}|${s.target}`:`${s.target}|${s.source}`;l.has(o)||l.set(o,[]),l.get(o).push(s)}),l.forEach(s=>{if(s.length===1)s[0].type="line",s[0].style={...s[0].style,curveOffset:0};else{const o=(s.length-1)/2;s.forEach((r,i)=>{r.type="quadratic",r.style={...r.style,curveOffset:(i-o)*30}})}}),m}const M=c.memo(function({data:l,meta:s}){const o=c.useRef(null),r=c.useRef(null),i=c.useRef(null),{selectedNodes:u,selectNode:R,deselectNode:w,clearSelection:g}=D(),{results:v}=L(),{addToast:C}=$(),x=c.useCallback(t=>{var d;const n=(d=t.target)==null?void 0:d.id;n&&(u.has(n)?w(n):R(n))},[u,R,w]),S=c.useCallback(()=>{g()},[g]),V=c.useCallback(t=>{var d,f,h,E;const n=(d=t.target)==null?void 0:d.id;if(!(!n||!i.current||!r.current))try{const e=r.current.getNodeData(n);if(!e)return;const a=r.current.getElementPosition(n),[y,z]=a||[0,0],N=`
        <div class="graph-node-tooltip">
          <div class="tooltip-title">${((f=e.data)==null?void 0:f.label)||e.id}</div>
          <div class="tooltip-id">ID: ${e.id}</div>
          ${(h=e.data)!=null&&h.description?`<div class="tooltip-desc">${e.data.description}</div>`:""}
          ${((E=e.data)==null?void 0:E.value)!==void 0?`<div class="tooltip-value">Value: ${e.data.value}</div>`:""}
        </div>
      `;i.current.innerHTML=N,i.current.style.display="block",i.current.style.left=y+10+"px",i.current.style.top=z+10+"px"}catch(e){console.warn("[GraphView] Error in handleNodeMouseEnter:",e)}},[]),G=c.useCallback(()=>{i.current&&(i.current.style.display="none")},[]),k=c.useCallback(t=>{t.key==="Escape"?g():(t.ctrlKey||t.metaKey)&&t.key==="f"?(t.preventDefault(),C("搜索面板已激活","info")):t.key==="Delete"&&u.size>0&&(u.forEach(n=>{w(n)}),C("已清除选中节点","success"))},[u,g,w,C]),I=c.useCallback(t=>{if(t)try{const n=t.getNodeData()||[],d=new Set(v);n.forEach(f=>{const h=f.id;if(d.has(h))t.setElementState(h,["highlight"]);else{const e=(t.getElementState(h)||[]).filter(a=>a!=="highlight");t.setElementState(h,e)}}),v.length>0&&t.focusElement(v[0])}catch(n){console.warn("[GraphView] Error in highlightSearchResults:",n)}},[v]);return c.useEffect(()=>{if(!(!o.current||!(l!=null&&l.nodes))){if(r.current){try{r.current.destroy()}catch(t){console.warn("[GraphView] Error destroying previous graph:",t)}r.current=null}try{const t=new K({container:o.current,width:o.current.clientWidth,height:o.current.clientHeight,layout:{type:"force",collide:{radius:e=>e.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:e=>{var a;return((a=e.data)==null?void 0:a.label)||e.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:e=>{var a;return((a=e.data)==null?void 0:a.label)||""},fontSize:10},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:l.nodes.map(e=>({...e,style:{...e.style,fill:u.has(e.id)?"#1890ff":"#87d068",lineWidth:u.has(e.id)?3:1,stroke:u.has(e.id)?"#1890ff":"#666"}})),edges:H((l.edges||[]).map(e=>({...e,style:{stroke:"#ccc",lineWidth:1,...e.style}})))}}),n=x,d=S,f=V,h=G;t.on(p.CLICK,n),t.on(T.CLICK,d),t.on(p.POINTER_ENTER,f),t.on(p.POINTER_LEAVE,h),t.on(p.DBLCLICK,e=>{var a;try{const y=(a=e.target)==null?void 0:a.id;if(!y)return;(t.getNeighborNodesData(y)||[]).forEach(N=>{t.setElementState(N.id,["highlight"])})}catch(y){console.warn("[GraphView] Error in dblclick handler:",y)}}),t.render().then(()=>{console.log("[GraphView] Graph rendered successfully"),I(t)}).catch(e=>{console.error("[GraphView] Error rendering graph:",e)});const E=()=>{if(o.current&&r.current)try{r.current.resize(o.current.clientWidth,o.current.clientHeight)}catch(e){console.warn("[GraphView] Error resizing graph:",e)}};return window.addEventListener("resize",E),window.addEventListener("keydown",k),r.current=t,()=>{if(window.removeEventListener("resize",E),window.removeEventListener("keydown",k),r.current)try{r.current.off(p.CLICK,n),r.current.off(T.CLICK,d),r.current.off(p.POINTER_ENTER,f),r.current.off(p.POINTER_LEAVE,h),r.current.destroy(),r.current=null}catch(e){console.warn("[GraphView] Error in cleanup:",e)}}}catch(t){return console.error("[GraphView] Error creating graph:",t),()=>{}}}},[l,u,x,S,V,G,k,I]),b.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden",children:[b.jsx("div",{ref:o,className:"graph-view flex-1"}),b.jsx("div",{ref:i,className:"graph-tooltip",style:{display:"none"}})]})});export{M as default};
//# sourceMappingURL=GraphView-CY19aDlz.js.map
