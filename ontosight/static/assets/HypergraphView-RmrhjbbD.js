import{r as a,u as L,b as W,d as _,j as z}from"./index-BoXFqNvM.js";const B=[{fill:"#1890FF",stroke:"#0050B3"},{fill:"#52C41A",stroke:"#274704"},{fill:"#FA8C16",stroke:"#872000"},{fill:"#EB2F96",stroke:"#780C56"},{fill:"#13C2C2",stroke:"#0C464C"},{fill:"#722ED1",stroke:"#38165F"},{fill:"#F5222D",stroke:"#7F0000"},{fill:"#FA541C",stroke:"#7F2C00"},{fill:"#FFC53D",stroke:"#7F6400"},{fill:"#45B39D",stroke:"#0F5C4C"}];function G(D){return B[D%B.length]}const N={fill:"#1890ff",stroke:"#0050b3"},j=a.memo(function({data:i,meta:I}){const f=a.useRef(null),s=a.useRef(null),w=a.useRef(new Map),C=a.useRef(new Map),y=a.useRef(new Map),{selectedItems:h,selectItem:b,deselectItem:g,clearSelection:S,resetTrigger:T}=L(),{results:k}=W(),{addToast:H}=_();a.useEffect(()=>{y.current=h},[h]);const v=a.useCallback(r=>{var u;const t=(u=r.target)==null?void 0:u.id;t&&(y.current.has(t)?g(t):b(t,"node"))},[b,g]),E=a.useCallback(r=>{y.current.has(r)?g(r):b(r,"hyperedge")},[b,g]),R=a.useCallback(r=>{r.key==="Escape"?S():(r.ctrlKey||r.metaKey)&&r.key==="f"?(r.preventDefault(),H("搜索面板已激活","info")):r.key==="Delete"&&y.current.size>0&&(y.current.forEach(t=>{g(t.id)}),H("已清除选中项","success"))},[S,g,H]),m=a.useCallback(r=>{if(r)try{const t=r.getNodeData()||[],u=new Set(k);t.forEach(d=>{const e=d.id;if(u.has(e))r.setElementState(e,["highlight"]);else{const l=(r.getElementState(e)||[]).filter(o=>o!=="highlight");r.setElementState(e,l)}}),k.length>0&&r.focusElement(k[0])}catch(t){console.warn("[HypergraphView] Error in highlightSearchResults:",t)}},[k]);return a.useEffect(()=>{if(!(!f.current||!(i!=null&&i.nodes)||!window.G6)){if(s.current){try{s.current.destroy()}catch(r){console.warn("[HypergraphView] Error destroying previous graph:",r)}s.current=null}try{w.current.clear(),C.current.clear();const r=(i.hyperedges||[]).map((e,n)=>{const l=G(n);w.current.set(e.id,e),C.current.set(e.id,l);const o=h.has(e.id),c=o?N:l;return{key:`bubble-sets-${e.id}`,type:"bubble-sets",members:e.node_set,fill:c.fill,fillOpacity:o?.3:.1,stroke:c.stroke,strokeOpacity:o?1:.6,label:!1,hyperedge:e}}),t=new window.G6.Graph({container:f.current,width:f.current.clientWidth,height:f.current.clientHeight,layout:{type:"force",collide:{radius:e=>e.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:e=>{var n;return((n=e.data)==null?void 0:n.label)||e.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:e=>{var n;return((n=e.data)==null?void 0:n.label)||""},fontSize:10,stroke:"#B4E5FF",opacity:.6},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:i.nodes.map(e=>{const n=h.has(e.id);return{...e,style:{...e.style,fill:n?"#1890ff":"#87d068",lineWidth:n?3:1,stroke:n?"#1890ff":"#666"}}}),edges:(i.edges||[]).map(e=>({...e,style:{stroke:"#B4E5FF",lineWidth:1,opacity:.6,...e.style}}))},plugins:r,autoFit:"center"});t.on("node:click",v);const u=e=>{var n,l,o;if(e.targetType==="bubble-sets"){const c=((n=e.target)==null?void 0:n.options)||e.target;if(console.log("[HypergraphView] Bubble-sets event:",c),c){if((l=c.hyperedge)!=null&&l.id)return E(c.hyperedge.id),!0;const p=(o=c.key)==null?void 0:o.replace("bubble-sets-","");if(p&&w.current.has(p))return E(p),!0;for(const[F,V]of w.current.entries()){const x=c.members||[];if(V.node_set&&x.length===V.node_set.length&&x.every(O=>V.node_set.includes(O)))return E(F),!0}}}return!1};t.on("click",e=>{if(console.log("[HypergraphView] Click event:",e.targetType,e.target),!u(e)&&e.targetType!=="node"&&e.targetType==="canvas"){S();return}}),t.on("pointerdown",e=>{e.targetType==="bubble-sets"&&(console.log("[HypergraphView] Pointerdown on bubble-sets:",e.target),u(e))}),t.on("pointermove",e=>{e.targetType==="bubble-sets"?f.current&&(f.current.style.cursor="pointer"):e.targetType==="canvas"&&f.current&&(f.current.style.cursor="default")}),t.on("node:dblclick",e=>{var n;try{const l=(n=e.target)==null?void 0:n.id;if(!l)return;(t.getNeighborNodesData(l)||[]).forEach(c=>{t.setElementState(c.id,["highlight"])})}catch(l){console.warn("[HypergraphView] Error in dblclick handler:",l)}}),t.render().then(()=>{console.log("[HypergraphView] Graph rendered successfully"),m(t)}).catch(e=>{console.error("[HypergraphView] Error rendering graph:",e)});const d=()=>{if(f.current&&s.current)try{s.current.resize(f.current.clientWidth,f.current.clientHeight)}catch(e){console.warn("[HypergraphView] Error resizing graph:",e)}};return window.addEventListener("resize",d),window.addEventListener("keydown",R),s.current=t,()=>{if(window.removeEventListener("resize",d),window.removeEventListener("keydown",R),s.current)try{s.current.destroy(),s.current=null}catch(e){console.warn("[HypergraphView] Error in cleanup:",e)}}}catch(r){return console.error("[HypergraphView] Error creating graph:",r),()=>{}}}},[i,v,E,R,m]),a.useEffect(()=>{if(!s.current||T===0)return;(async()=>{var t,u,d;try{console.log("[HypergraphView] Full re-render with cold-start layout..."),(t=s.current)==null||t.stopLayout();const e=i.nodes.map(({x:n,y:l,...o})=>o);(u=s.current)==null||u.setData({nodes:e,edges:i.edges||[]}),await((d=s.current)==null?void 0:d.render()),s.current&&m(s.current),console.log("[HypergraphView] Full re-render completed")}catch(e){console.warn("[HypergraphView] Error during full re-render:",e)}})()},[T,i,m]),a.useEffect(()=>{if(!s.current||!i)return;(async()=>{var t,u,d;try{(t=i.nodes)==null||t.forEach(e=>{var l;const n=h.has(e.id);(l=s.current)==null||l.updateNodeData([{id:e.id,style:{fill:n?"#1890ff":"#87d068",lineWidth:n?3:1,stroke:n?"#1890ff":"#666"}}])}),(u=i.hyperedges)==null||u.forEach(e=>{var p;const n=h.has(e.id),l=C.current.get(e.id);if(!l)return;const o=n?N:l,c=`bubble-sets-${e.id}`;try{(p=s.current)==null||p.updatePlugin({key:c,fill:o.fill,fillOpacity:n?.3:.1,stroke:o.stroke,strokeOpacity:n?1:.6,labelBackgroundFill:o.stroke})}catch(F){console.warn("[HypergraphView] Error updating plugin:",c,F)}}),await((d=s.current)==null?void 0:d.draw())}catch(e){console.warn("[HypergraphView] Error updating selection styles:",e)}})()},[h,i]),z.jsx("div",{className:"w-full h-full flex flex-col overflow-hidden",children:z.jsx("div",{ref:f,className:"hypergraph-view flex-1"})})});export{j as default};
//# sourceMappingURL=HypergraphView-RmrhjbbD.js.map
