import{r as i,u as N,b as P,d as W,j as B}from"./index-CzFOrGUA.js";const z=[{fill:"#1890FF",stroke:"#0050B3"},{fill:"#52C41A",stroke:"#274704"},{fill:"#FA8C16",stroke:"#872000"},{fill:"#EB2F96",stroke:"#780C56"},{fill:"#13C2C2",stroke:"#0C464C"},{fill:"#722ED1",stroke:"#38165F"},{fill:"#F5222D",stroke:"#7F0000"},{fill:"#FA541C",stroke:"#7F2C00"},{fill:"#FFC53D",stroke:"#7F6400"},{fill:"#45B39D",stroke:"#0F5C4C"}];function _(V){return z[V%z.length]}const O={fill:"#1890ff",stroke:"#0050b3"},j=i.memo(function({data:f,meta:G}){const u=i.useRef(null),l=i.useRef(null),b=i.useRef(new Map),m=i.useRef(new Map),y=i.useRef(new Map),{selectedItems:h,selectItem:w,deselectItem:g,clearSelection:C,resetTrigger:D}=N(),{results:k}=P(),{addToast:S}=W();i.useEffect(()=>{y.current=h},[h]);const T=i.useCallback(r=>{var c;const t=(c=r.target)==null?void 0:c.id;t&&(y.current.has(t)?g(t):w(t,"node"))},[w,g]),E=i.useCallback(r=>{y.current.has(r)?g(r):w(r,"hyperedge")},[w,g]),H=i.useCallback(r=>{r.key==="Escape"?C():(r.ctrlKey||r.metaKey)&&r.key==="f"?(r.preventDefault(),S("搜索面板已激活","info")):r.key==="Delete"&&y.current.size>0&&(y.current.forEach(t=>{g(t.id)}),S("已清除选中项","success"))},[C,g,S]),v=i.useCallback(r=>{if(r)try{const t=r.getNodeData()||[],c=new Set(k);t.forEach(d=>{const e=d.id;if(c.has(e))r.setElementState(e,["highlight"]);else{const n=(r.getElementState(e)||[]).filter(a=>a!=="highlight");r.setElementState(e,n)}}),k.length>0&&r.focusElement(k[0])}catch(t){console.warn("[HypergraphView] Error in highlightSearchResults:",t)}},[k]);return i.useEffect(()=>{if(!(!u.current||!(f!=null&&f.nodes)||!window.G6)){if(l.current){try{l.current.destroy()}catch(r){console.warn("[HypergraphView] Error destroying previous graph:",r)}l.current=null}try{b.current.clear(),m.current.clear();const r=(f.hyperedges||[]).map((e,s)=>{const n=_(s);b.current.set(e.id,e),m.current.set(e.id,n);const a=h.has(e.id),o=a?O:n;return{key:`bubble-sets-${e.id}`,type:"bubble-sets",members:e.node_set,labelText:e.label,fill:o.fill,fillOpacity:a?.3:.1,stroke:o.stroke,strokeOpacity:a?1:.6,label:!0,labelCloseToPath:!1,labelPlacement:"top",labelBackgroundFill:o.stroke,labelFill:"#fff",labelPadding:3,labelBackgroundRadius:4,hyperedge:e}}),t=new window.G6.Graph({container:u.current,width:u.current.clientWidth,height:u.current.clientHeight,layout:{type:"force",collide:{radius:e=>e.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:e=>{var s;return((s=e.data)==null?void 0:s.label)||e.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:e=>{var s;return((s=e.data)==null?void 0:s.label)||""},fontSize:10,stroke:"#B4E5FF",opacity:.6},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:f.nodes.map(e=>{const s=h.has(e.id);return{...e,style:{...e.style,fill:s?"#1890ff":"#87d068",lineWidth:s?3:1,stroke:s?"#1890ff":"#666"}}}),edges:(f.edges||[]).map(e=>({...e,style:{stroke:"#B4E5FF",lineWidth:1,opacity:.6,...e.style}}))},plugins:r,autoFit:"center"});t.on("node:click",T);const c=e=>{var s,n,a;if(e.targetType==="bubble-sets"){const o=((s=e.target)==null?void 0:s.options)||e.target;if(console.log("[HypergraphView] Bubble-sets event:",o),o){if((n=o.hyperedge)!=null&&n.id)return E(o.hyperedge.id),!0;const p=(a=o.key)==null?void 0:a.replace("bubble-sets-","");if(p&&b.current.has(p))return E(p),!0;for(const[R,F]of b.current.entries()){const x=o.members||[];if(F.node_set&&x.length===F.node_set.length&&x.every(L=>F.node_set.includes(L)))return E(R),!0}}}return!1};t.on("click",e=>{if(console.log("[HypergraphView] Click event:",e.targetType,e.target),!c(e)&&e.targetType!=="node"&&e.targetType==="canvas"){C();return}}),t.on("pointerdown",e=>{e.targetType==="bubble-sets"&&(console.log("[HypergraphView] Pointerdown on bubble-sets:",e.target),c(e))}),t.on("pointermove",e=>{e.targetType==="bubble-sets"?u.current&&(u.current.style.cursor="pointer"):e.targetType==="canvas"&&u.current&&(u.current.style.cursor="default")}),t.on("node:dblclick",e=>{var s;try{const n=(s=e.target)==null?void 0:s.id;if(!n)return;(t.getNeighborNodesData(n)||[]).forEach(o=>{t.setElementState(o.id,["highlight"])})}catch(n){console.warn("[HypergraphView] Error in dblclick handler:",n)}}),t.render().then(()=>{console.log("[HypergraphView] Graph rendered successfully"),v(t)}).catch(e=>{console.error("[HypergraphView] Error rendering graph:",e)});const d=()=>{if(u.current&&l.current)try{l.current.resize(u.current.clientWidth,u.current.clientHeight)}catch(e){console.warn("[HypergraphView] Error resizing graph:",e)}};return window.addEventListener("resize",d),window.addEventListener("keydown",H),l.current=t,()=>{if(window.removeEventListener("resize",d),window.removeEventListener("keydown",H),l.current)try{l.current.destroy(),l.current=null}catch(e){console.warn("[HypergraphView] Error in cleanup:",e)}}}catch(r){return console.error("[HypergraphView] Error creating graph:",r),()=>{}}}},[f,T,E,H,v]),i.useEffect(()=>{if(!l.current||D===0)return;(async()=>{var t,c;try{console.log("[HypergraphView] Relayouting graph..."),(t=l.current)==null||t.stopLayout(),await((c=l.current)==null?void 0:c.layout()),console.log("[HypergraphView] Relayout completed")}catch(d){console.warn("[HypergraphView] Error relayouting graph on reset:",d)}})()},[D]),i.useEffect(()=>{if(!l.current||!f)return;(async()=>{var t,c,d;try{(t=f.nodes)==null||t.forEach(e=>{var n;const s=h.has(e.id);(n=l.current)==null||n.updateNodeData([{id:e.id,style:{fill:s?"#1890ff":"#87d068",lineWidth:s?3:1,stroke:s?"#1890ff":"#666"}}])}),(c=f.hyperedges)==null||c.forEach(e=>{var p;const s=h.has(e.id),n=m.current.get(e.id);if(!n)return;const a=s?O:n,o=`bubble-sets-${e.id}`;try{(p=l.current)==null||p.updatePlugin({key:o,fill:a.fill,fillOpacity:s?.3:.1,stroke:a.stroke,strokeOpacity:s?1:.6,labelBackgroundFill:a.stroke})}catch(R){console.warn("[HypergraphView] Error updating plugin:",o,R)}}),await((d=l.current)==null?void 0:d.draw())}catch(e){console.warn("[HypergraphView] Error updating selection styles:",e)}})()},[h,f]),B.jsx("div",{className:"w-full h-full flex flex-col overflow-hidden",children:B.jsx("div",{ref:u,className:"hypergraph-view flex-1"})})});export{j as default};
//# sourceMappingURL=HypergraphView-CdC7NPK6.js.map
