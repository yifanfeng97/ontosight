{"version":3,"file":"HypergraphView-BM60QRrk.js","sources":["../../../frontend/src/components/views/HypergraphView.tsx"],"sourcesContent":["import { useEffect, useRef, useCallback, memo } from \"react\";\r\nimport { useVisualization } from \"@/hooks/useVisualization\";\r\nimport { useToast } from \"@/components/ui/toast\";\r\n\r\n// 使用全局 G6（通过 index.html 中的 script 标签引入 g6.min.js）\r\ndeclare global {\r\n  interface Window {\r\n    G6: any;\r\n  }\r\n}\r\n\r\ninterface HypergraphViewProps {\r\n  data: {\r\n    nodes: any[];\r\n    edges: any[];\r\n    hyperedges: Array<{\r\n      id: string;\r\n      label: string;\r\n      linked_nodes: string[];\r\n      data: any;\r\n      highlighted?: boolean;\r\n    }>;\r\n  };\r\n  meta: any;\r\n}\r\n\r\n// 颜色调色板，为每个超边生成不同颜色\r\nconst HYPEREDGE_COLORS = [\r\n  { fill: \"#1890FF\", stroke: \"#0050B3\" },\r\n  { fill: \"#52C41A\", stroke: \"#274704\" },\r\n  { fill: \"#FA8C16\", stroke: \"#872000\" },\r\n  { fill: \"#EB2F96\", stroke: \"#780C56\" },\r\n  { fill: \"#13C2C2\", stroke: \"#0C464C\" },\r\n  { fill: \"#722ED1\", stroke: \"#38165F\" },\r\n  { fill: \"#F5222D\", stroke: \"#7F0000\" },\r\n  { fill: \"#FA541C\", stroke: \"#7F2C00\" },\r\n  { fill: \"#FFC53D\", stroke: \"#7F6400\" },\r\n  { fill: \"#45B39D\", stroke: \"#0F5C4C\" },\r\n];\r\n\r\nfunction getHyperedgeColor(index: number) {\r\n  return HYPEREDGE_COLORS[index % HYPEREDGE_COLORS.length];\r\n}\r\n\r\n// 选中状态的超边颜色\r\nconst SELECTED_HYPEREDGE_COLOR = { fill: \"#1890ff\", stroke: \"#0050b3\" };\r\n\r\nconst HypergraphView = memo(function HypergraphView({ data, meta }: HypergraphViewProps) {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const graphRef = useRef<any>(null);\r\n  const hyperedgesRef = useRef<Map<string, any>>(new Map()); // Store hyperedges for click detection\r\n  const hyperedgeColorsRef = useRef<Map<string, { fill: string; stroke: string }>>(new Map()); // Store original colors\r\n  const selectedItemsRef = useRef(new Map());\r\n  const { selectedItems, selectItem, deselectItem, clearSelection, resetTrigger } = useVisualization();\r\n  const { addToast } = useToast();\r\n\r\n  // Keep ref in sync with state\r\n  useEffect(() => {\r\n    selectedItemsRef.current = selectedItems;\r\n  }, [selectedItems]);\r\n\r\n  const handleNodeClick = useCallback(\r\n    (evt: any) => {\r\n      const nodeId = evt.target?.id;\r\n      if (!nodeId) return;\r\n\r\n      selectItem(nodeId, \"node\");\r\n    },\r\n    [selectItem]\r\n  );\r\n\r\n  const handleHyperedgeClick = useCallback(\r\n    (hyperedgeId: string) => {\r\n      selectItem(hyperedgeId, \"hyperedge\");\r\n    },\r\n    [selectItem]\r\n  );\r\n\r\n  const handleKeyDown = useCallback((evt: KeyboardEvent) => {\r\n    if (evt.key === 'Escape') {\r\n      clearSelection();\r\n    } else if ((evt.ctrlKey || evt.metaKey) && evt.key === 'f') {\r\n      evt.preventDefault();\r\n      addToast('搜索面板已激活', 'info');\r\n    } else if (evt.key === 'Delete' && selectedItemsRef.current.size > 0) {\r\n      selectedItemsRef.current.forEach((item) => {\r\n        deselectItem(item.id);\r\n      });\r\n      addToast('已清除选中项', 'success');\r\n    }\r\n  }, [clearSelection, deselectItem, addToast]);\r\n\r\n  const highlightSearchResults = useCallback((graph: any) => {\r\n    if (!graph) return;\r\n\r\n    try {\r\n      const allNodeData = graph.getNodeData() || [];\r\n\r\n      allNodeData.forEach((nodeData: any) => {\r\n        const nodeId = nodeData.id;\r\n        // 只检查数据中的 highlighted 标志位，不再从搜索结果中获取\r\n        if (nodeData.highlighted) {\r\n          graph.setElementState(nodeId, ['highlight']);\r\n        } else {\r\n          // 清除节点的高亮状态（保留其他状态如selected）\r\n          const currentStates = graph.getElementState(nodeId) || [];\r\n          const newStates = currentStates.filter((state: string) => state !== 'highlight');\r\n          graph.setElementState(nodeId, newStates);\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.warn(\"[HypergraphView] Error in highlightSearchResults:\", error);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    // 检查 G6 是否已加载（通过 index.html 中的 script 标签引入）\r\n    if (!containerRef.current || !data?.nodes || !window.G6) {\r\n      return;\r\n    }\r\n\r\n    // Clean up old graph\r\n    if (graphRef.current) {\r\n      try {\r\n        graphRef.current.destroy();\r\n      } catch (e) {\r\n        console.warn(\"[HypergraphView] Error destroying previous graph:\", e);\r\n      }\r\n      graphRef.current = null;\r\n    }\r\n\r\n    try {\r\n      // Clear old hyperedge data before rebuilding\r\n      hyperedgesRef.current.clear();\r\n      hyperedgeColorsRef.current.clear();\r\n\r\n      // Build bubble-sets plugins from hyperedges\r\n      const bubbleSetPlugins = (data.hyperedges || []).map((hyperedge, index) => {\r\n        const colors = getHyperedgeColor(index);\r\n        // Store hyperedge metadata and original colors for click detection and style updates\r\n        hyperedgesRef.current.set(hyperedge.id, hyperedge);\r\n        hyperedgeColorsRef.current.set(hyperedge.id, colors);\r\n\r\n        // Check if this hyperedge is selected or highlighted\r\n        const isSelected = selectedItems.has(hyperedge.id);\r\n        const isHighlighted = hyperedge.highlighted === true;\r\n        \r\n        // Highlighted takes precedence, then selected\r\n        let activeColors = colors;\r\n        if (isHighlighted) {\r\n          activeColors = { fill: \"#FFD700\", stroke: \"#FFA500\" };\r\n        } else if (isSelected) {\r\n          activeColors = SELECTED_HYPEREDGE_COLOR;\r\n        }\r\n\r\n        return {\r\n          key: `bubble-sets-${hyperedge.id}`,\r\n          type: 'bubble-sets',\r\n          members: hyperedge.linked_nodes,\r\n          fill: activeColors.fill,\r\n          fillOpacity: isSelected || isHighlighted ? 0.3 : 0.1,\r\n          stroke: activeColors.stroke,\r\n          strokeOpacity: isSelected || isHighlighted ? 1 : 0.6,\r\n          label: false,\r\n          // Store hyperedge data for click event detection (reference: HypergraphViewer)\r\n          hyperedge: hyperedge,\r\n        };\r\n      });\r\n\r\n      // Create new graph with G6 (使用全局 window.G6，参考 HypergraphViewer)\r\n      const graph = new window.G6.Graph({\r\n        container: containerRef.current,\r\n        width: containerRef.current.clientWidth,\r\n        height: containerRef.current.clientHeight,\r\n        layout: {\r\n          type: 'force',\r\n          collide: {\r\n            radius: (d: any) => d.size / 2,\r\n          },\r\n          preventOverlap: true,\r\n        },\r\n        behaviors: ['drag-canvas', 'zoom-canvas', 'drag-element'],\r\n        node: {\r\n          style: {\r\n            labelText: (d: any) => d.data?.label || d.id,\r\n            fontSize: 12,\r\n          },\r\n          state: {\r\n            highlight: {\r\n              fill: '#ffd666',\r\n              stroke: '#faad14',\r\n              lineWidth: 2,\r\n              shadowColor: '#faad14',\r\n              shadowBlur: 10,\r\n            },\r\n            selected: {\r\n              fill: '#1890ff',\r\n              stroke: '#1890ff',\r\n              lineWidth: 3,\r\n              shadowColor: '#1890ff',\r\n              shadowBlur: 10,\r\n            },\r\n          },\r\n        },\r\n        edge: {\r\n          style: {\r\n            labelText: (d: any) => d.data?.label || '',\r\n            fontSize: 10,\r\n            stroke: '#B4E5FF',\r\n            opacity: 0.6,\r\n          },\r\n          state: {\r\n            highlight: {\r\n              stroke: '#faad14',\r\n              lineWidth: 2,\r\n              opacity: 1,\r\n            },\r\n          },\r\n        },\r\n        data: {\r\n          nodes: data.nodes.map((node: any) => {\r\n            const isSelected = selectedItems.has(node.id);\r\n            const isHighlighted = node.highlighted === true;\r\n            return {\r\n              ...node,\r\n              style: {\r\n                ...node.style,\r\n                fill: isHighlighted ? \"#FFD700\" : (isSelected ? \"#1890ff\" : \"#87d068\"),\r\n                lineWidth: isSelected ? 3 : (isHighlighted ? 2 : 1),\r\n                stroke: isHighlighted ? \"#FFA500\" : (isSelected ? \"#1890ff\" : \"#666\"),\r\n              },\r\n            };\r\n          }),\r\n          edges: (data.edges || []).map((edge: any) => ({\r\n            ...edge,\r\n            style: {\r\n              stroke: 'transparent',\r\n              lineWidth: 0,\r\n              opacity: 0,\r\n              ...edge.style,\r\n            },\r\n          })),\r\n        },\r\n        plugins: bubbleSetPlugins,\r\n        autoFit: 'center',\r\n      });\r\n\r\n      // Register event handlers for nodes\r\n      graph.on(\"node:click\", handleNodeClick);\r\n\r\n      // Helper function to handle bubble-sets click\r\n      const handleBubbleSetsEvent = (evt: any) => {\r\n        if (evt.targetType === \"bubble-sets\") {\r\n          const target = evt.target?.options || evt.target;\r\n          console.log(\"[HypergraphView] Bubble-sets event:\", target);\r\n          if (target) {\r\n            // Try to get hyperedge id directly from stored hyperedge data\r\n            if (target.hyperedge?.id) {\r\n              handleHyperedgeClick(target.hyperedge.id);\r\n              return true;\r\n            }\r\n            // Fallback: find hyperedge by key\r\n            const key = target.key?.replace('bubble-sets-', '');\r\n            if (key && hyperedgesRef.current.has(key)) {\r\n              handleHyperedgeClick(key);\r\n              return true;\r\n            }\r\n            // Fallback: find by members\r\n            for (const [hyperedgeId, hyperedgeData] of hyperedgesRef.current.entries()) {\r\n              const targetMembers = target.members || [];\r\n              if (hyperedgeData.node_set &&\r\n                  targetMembers.length === hyperedgeData.node_set.length &&\r\n                  targetMembers.every((m: string) => hyperedgeData.node_set.includes(m))) {\r\n                handleHyperedgeClick(hyperedgeId);\r\n                return true;\r\n              }\r\n            }\r\n          }\r\n        }\r\n        return false;\r\n      };\r\n\r\n      // Register global click handler to detect bubble-sets clicks\r\n      // Reference: HypergraphViewer uses graph.on(\"pointermove\", ...) with targetType === \"bubble-sets\"\r\n      graph.on(\"click\", (evt: any) => {\r\n        console.log(\"[HypergraphView] Click event:\", evt.targetType, evt.target);\r\n\r\n        // Check if clicked on a bubble-sets (hyperedge)\r\n        if (handleBubbleSetsEvent(evt)) {\r\n          return;\r\n        }\r\n\r\n        // Check if clicked on node (already handled by NodeEvent.CLICK, but just in case)\r\n        if (evt.targetType === \"node\") {\r\n          return; // Let NodeEvent.CLICK handle it\r\n        }\r\n\r\n        // Check if clicked on canvas (empty area)\r\n        if (evt.targetType === \"canvas\") {\r\n          clearSelection();\r\n          return;\r\n        }\r\n      });\r\n\r\n      // Also listen to pointerdown for bubble-sets (some versions of G6 may use this)\r\n      graph.on(\"pointerdown\", (evt: any) => {\r\n        if (evt.targetType === \"bubble-sets\") {\r\n          console.log(\"[HypergraphView] Pointerdown on bubble-sets:\", evt.target);\r\n          handleBubbleSetsEvent(evt);\r\n        }\r\n      });\r\n\r\n      // Listen to pointermove to detect hovering over bubble-sets (like HypergraphViewer)\r\n      graph.on(\"pointermove\", (evt: any) => {\r\n        if (evt.targetType === \"bubble-sets\") {\r\n          // Set cursor to pointer when hovering over hyperedge\r\n          if (containerRef.current) {\r\n            containerRef.current.style.cursor = \"pointer\";\r\n          }\r\n        } else if (evt.targetType === \"canvas\") {\r\n          if (containerRef.current) {\r\n            containerRef.current.style.cursor = \"default\";\r\n          }\r\n        }\r\n      });\r\n\r\n      // Double-click to highlight neighbors\r\n      graph.on(\"node:dblclick\", (evt: any) => {\r\n        try {\r\n          const nodeId = evt.target?.id;\r\n          if (!nodeId) return;\r\n          const neighbors = graph.getNeighborNodesData(nodeId) || [];\r\n          neighbors.forEach((neighbor: any) => {\r\n            graph.setElementState(neighbor.id, ['highlight']);\r\n          });\r\n        } catch (error) {\r\n          console.warn(\"[HypergraphView] Error in dblclick handler:\", error);\r\n        }\r\n      });\r\n\r\n      // Render and apply search highlighting\r\n      graph.render().then(() => {\r\n        console.log(\"[HypergraphView] Graph rendered successfully\");\r\n        highlightSearchResults(graph);\r\n      }).catch((error: any) => {\r\n        console.error(\"[HypergraphView] Error rendering graph:\", error);\r\n      });\r\n\r\n      // Handle resize\r\n      const handleResize = () => {\r\n        if (containerRef.current && graphRef.current) {\r\n          try {\r\n            graphRef.current.resize(\r\n              containerRef.current.clientWidth,\r\n              containerRef.current.clientHeight\r\n            );\r\n          } catch (error) {\r\n            console.warn(\"[HypergraphView] Error resizing graph:\", error);\r\n          }\r\n        }\r\n      };\r\n\r\n      window.addEventListener(\"resize\", handleResize);\r\n      window.addEventListener(\"keydown\", handleKeyDown);\r\n      graphRef.current = graph;\r\n          \r\n      // Cleanup function\r\n      return () => {\r\n        window.removeEventListener(\"resize\", handleResize);\r\n        window.removeEventListener(\"keydown\", handleKeyDown);\r\n\r\n        if (graphRef.current) {\r\n          try {\r\n            graphRef.current.destroy();\r\n            graphRef.current = null;\r\n          } catch (e) {\r\n            console.warn(\"[HypergraphView] Error in cleanup:\", e);\r\n          }\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error(\"[HypergraphView] Error creating graph:\", error);\r\n      return () => { };\r\n    }\r\n  }, [data, handleNodeClick, handleHyperedgeClick, handleKeyDown, highlightSearchResults]);\r\n\r\n  // Re-render graph when reset is triggered (full refresh with cold-start layout)\r\n  useEffect(() => {\r\n    if (!graphRef.current || resetTrigger === 0) return;\r\n\r\n    const fullRerender = async () => {\r\n      try {\r\n        // Validate graph instance before proceeding\r\n        if (!graphRef.current) {\r\n          console.warn(\"[HypergraphView] Graph instance is null, skipping re-render\");\r\n          return;\r\n        }\r\n\r\n        console.log(\"[HypergraphView] Full re-render with cold-start layout...\");\r\n        \r\n        // Clear node coordinates for cold-start layout (not based on current positions)\r\n        const cleanNodes = data.nodes.map(({ x, y, ...rest }: any) => rest);\r\n        \r\n        // Re-set data with cleaned coordinates\r\n        // setData() will trigger layout reconciliation automatically\r\n        graphRef.current.setData({\r\n          nodes: cleanNodes,\r\n          edges: data.edges || [],\r\n        });\r\n        \r\n        // Full render: triggers data reconciliation -> layout calculation -> drawing\r\n        // This will also recalculate BubbleSet hyperedge paths\r\n        // Note: No need to explicitly call stopLayout() - G6 handles this internally\r\n        await graphRef.current.render();\r\n        \r\n        // Re-apply search highlighting after render completes\r\n        if (graphRef.current) {\r\n          highlightSearchResults(graphRef.current);\r\n        }\r\n        \r\n        console.log(\"[HypergraphView] Full re-render completed\");\r\n      } catch (error) {\r\n        console.warn(\"[HypergraphView] Error during full re-render:\", error);\r\n      }\r\n    };\r\n\r\n    fullRerender();\r\n  }, [resetTrigger, data, highlightSearchResults]);\r\n\r\n  // Update hyperedge and node styles when selection changes (without redrawing)\r\n  useEffect(() => {\r\n    if (!graphRef.current || !data) return;\r\n\r\n    const updateStyles = async () => {\r\n      try {\r\n        // Update node styles based on selection and highlight state\r\n        data.nodes?.forEach((node: any) => {\r\n          const isSelected = selectedItems.has(node.id);\r\n          const isHighlighted = node.highlighted === true;\r\n          graphRef.current?.updateNodeData([{\r\n            id: node.id,\r\n            style: {\r\n              fill: isHighlighted ? \"#FFD700\" : (isSelected ? \"#1890ff\" : \"#87d068\"),\r\n              lineWidth: isSelected ? 3 : (isHighlighted ? 2 : 1),\r\n              stroke: isHighlighted ? \"#FFA500\" : (isSelected ? \"#1890ff\" : \"#666\"),\r\n            },\r\n          }]);\r\n        });\r\n\r\n        // Update hyperedge (bubble-sets) styles based on selection and highlight state\r\n        data.hyperedges?.forEach((hyperedge: any) => {\r\n          const isSelected = selectedItems.has(hyperedge.id);\r\n          const isHighlighted = hyperedge.highlighted === true;\r\n          const originalColors = hyperedgeColorsRef.current.get(hyperedge.id);\r\n          if (!originalColors) return;\r\n\r\n          let activeColors = originalColors;\r\n          if (isHighlighted) {\r\n            activeColors = { fill: \"#FFD700\", stroke: \"#FFA500\" };\r\n          } else if (isSelected) {\r\n            activeColors = SELECTED_HYPEREDGE_COLOR;\r\n          }\r\n\r\n          const pluginKey = `bubble-sets-${hyperedge.id}`;\r\n\r\n          try {\r\n            graphRef.current?.updatePlugin({\r\n              key: pluginKey,\r\n              fill: activeColors.fill,\r\n              fillOpacity: isSelected || isHighlighted ? 0.3 : 0.1,\r\n              stroke: activeColors.stroke,\r\n              strokeOpacity: isSelected || isHighlighted ? 1 : 0.6,\r\n              labelBackgroundFill: activeColors.stroke,\r\n            });\r\n          } catch (e) {\r\n            console.warn(\"[HypergraphView] Error updating plugin:\", pluginKey, e);\r\n          }\r\n        });\r\n\r\n        // Draw immediately to show style changes\r\n        await graphRef.current?.draw();\r\n      } catch (error) {\r\n        console.warn(\"[HypergraphView] Error updating selection styles:\", error);\r\n      }\r\n    };\r\n\r\n    updateStyles();\r\n  }, [selectedItems, data]);\r\n\r\n  return (\r\n    <div className=\"w-full h-full flex flex-col overflow-hidden\">\r\n      <div ref={containerRef} className=\"hypergraph-view flex-1\" />\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default HypergraphView;\r\n"],"names":["HYPEREDGE_COLORS","getHyperedgeColor","index","SELECTED_HYPEREDGE_COLOR","HypergraphView","memo","data","meta","containerRef","useRef","graphRef","hyperedgesRef","hyperedgeColorsRef","selectedItemsRef","selectedItems","selectItem","deselectItem","clearSelection","resetTrigger","useVisualization","addToast","useToast","useEffect","handleNodeClick","useCallback","evt","nodeId","_a","handleHyperedgeClick","hyperedgeId","handleKeyDown","item","highlightSearchResults","graph","nodeData","newStates","state","error","e","bubbleSetPlugins","hyperedge","colors","isSelected","isHighlighted","activeColors","d","node","edge","handleBubbleSetsEvent","target","_b","key","_c","hyperedgeData","targetMembers","m","neighbor","handleResize","cleanNodes","x","y","rest","originalColors","pluginKey","jsx"],"mappings":"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"}