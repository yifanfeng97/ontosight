{"version":3,"file":"HypergraphView-BgVE5cIU.js","sources":["../../../frontend/src/components/views/HypergraphView.tsx"],"sourcesContent":["import React, { useEffect, useRef } from 'react';\r\nimport * as G6 from '@antv/g6';\r\nimport { useVisualization } from '../../hooks/useVisualization';\r\nimport { useSearch } from '../../hooks/useSearch';\r\nimport { message } from 'antd';\r\nimport './HypergraphView.css';\r\n\r\n/**\r\n * HypergraphView: 超图可视化组件\r\n *\r\n * 超图是一种图数据结构，其中边可以连接多个节点（而不仅仅是两个）。\r\n * 这个组件使用虚拟中间节点来表示超边，并将其连接到所有参与的节点。\r\n *\r\n * 渲染策略:\r\n * 1. 为每个超边创建虚拟节点\r\n * 2. 虚拟节点连接到所有参与的节点\r\n * 3. 虚拟节点样式不同（使其可识别）\r\n * 4. 用户交互支持选中、拖拽、高亮\r\n */\r\n\r\ninterface GraphData {\r\n  nodes: Array<{\r\n    id: string;\r\n    label: string;\r\n    type?: string;\r\n  }>;\r\n  edges: Array<{\r\n    source: string;\r\n    target: string;\r\n    label?: string;\r\n  }>;\r\n}\r\n\r\ninterface HyperEdge {\r\n  id: string;\r\n  label: string;\r\n  nodes: string[];\r\n  color?: string;\r\n}\r\n\r\nconst HypergraphView: React.FC = () => {\r\n  const canvasRef = useRef<HTMLDivElement>(null);\r\n  const graphRef = useRef<any>(null);\r\n  const { data, selectedNodes } = useVisualization();\r\n  const { results: searchResults } = useSearch();\r\n\r\n  useEffect(() => {\r\n    if (!canvasRef.current) return;\r\n\r\n    try {\r\n      // 验证数据\r\n      if (!data || !data.nodes || !data.edges) {\r\n        message.warning('缺少超图数据');\r\n        return;\r\n      }\r\n\r\n      // 准备超图数据\r\n      const { hyperEdges, transformedData } = transformDataToHypergraph(\r\n        data as GraphData\r\n      );\r\n\r\n      // 初始化或更新 G6 图表\r\n      if (!graphRef.current) {\r\n        graphRef.current = createGraph(canvasRef.current, transformedData);\r\n      } else {\r\n        (graphRef.current as any).data(transformedData);\r\n        graphRef.current.render();\r\n      }\r\n\r\n      // 绑定交互事件\r\n      if (graphRef.current) {\r\n        bindInteractions(graphRef.current, hyperEdges);\r\n      }\r\n\r\n      // 应用搜索高亮\r\n      if (searchResults.length > 0 && graphRef.current) {\r\n        highlightSearchResults(graphRef.current, searchResults);\r\n      }\r\n    } catch (error) {\r\n      console.error('Hypergraph 渲染错误:', error);\r\n      message.error('超图可视化失败');\r\n    }\r\n\r\n    // 清理\r\n    return () => {\r\n      if (graphRef.current) {\r\n        graphRef.current.destroy();\r\n        graphRef.current = null;\r\n      }\r\n    };\r\n  }, [data, searchResults]);\r\n\r\n  return <div ref={canvasRef} className=\"hypergraph-view\" />;\r\n};\r\n\r\n/**\r\n * 将普通图数据转换为超图数据\r\n * 创建虚拟超边节点并连接到所有参与的节点\r\n */\r\nfunction transformDataToHypergraph(data: GraphData) {\r\n  const hyperEdges: HyperEdge[] = [];\r\n  const virtualNodes: typeof data.nodes = [];\r\n  const virtualEdges: typeof data.edges = [];\r\n\r\n  // 检测超边（连接多个节点的边）\r\n  const edgesBySource = new Map<string, string[]>();\r\n\r\n  // 如果有自定义的超边标记，使用它\r\n  // 否则，多个节点连接到同一源的边视为超边\r\n  data.edges.forEach((edge, index) => {\r\n    if (!edgesBySource.has(edge.source)) {\r\n      edgesBySource.set(edge.source, []);\r\n    }\r\n    edgesBySource.get(edge.source)!.push(edge.target);\r\n  });\r\n\r\n  // 创建虚拟超边节点\r\n  edgesBySource.forEach((targets, source) => {\r\n    if (targets.length >= 2) {\r\n      // 这是一个超边（一对多）\r\n      const hyperedgeId = `hyperedge-${source}-${targets.join('-')}`;\r\n      const hyperEdge: HyperEdge = {\r\n        id: hyperedgeId,\r\n        label: `HyperEdge (${targets.length} nodes)`,\r\n        nodes: targets,\r\n        color: '#722ed1', // 紫色用于超边\r\n      };\r\n\r\n      hyperEdges.push(hyperEdge);\r\n\r\n      // 创建虚拟节点代表此超边\r\n      virtualNodes.push({\r\n        id: hyperedgeId,\r\n        label: hyperEdge.label,\r\n        type: 'hyperEdge',\r\n      });\r\n\r\n      // 创建虚拟边：超边 -> 所有目标节点\r\n      targets.forEach((target) => {\r\n        virtualEdges.push({\r\n          source: hyperedgeId,\r\n          target: target,\r\n          label: '', // 虚拟边不需要标签\r\n        });\r\n      });\r\n    }\r\n  });\r\n\r\n  // 合并数据\r\n  const transformedData: GraphData = {\r\n    nodes: [...data.nodes, ...virtualNodes],\r\n    edges: [...data.edges, ...virtualEdges],\r\n  };\r\n\r\n  return { hyperEdges, transformedData };\r\n}\r\n\r\n/**\r\n * 创建 G6 图表实例\r\n */\r\nfunction createGraph(container: HTMLDivElement, data: GraphData) {\r\n  // 注册自定义超边节点\r\n  if (!(G6 as any).registered('hyperEdge')) {\r\n    (G6 as any).register('node', 'hyperEdge', {\r\n      draw(cfg: any, group: any) {\r\n        // 绘制虚拟节点为带边框的圆圈\r\n        const r = 10;\r\n        const color = cfg.color || '#722ed1';\r\n\r\n        group.addShape('circle', {\r\n          attrs: {\r\n            x: 0,\r\n            y: 0,\r\n            r: r,\r\n            fill: '#fff',\r\n            stroke: color,\r\n            lineWidth: 2,\r\n            dashArray: [5, 5], // 虚线样式\r\n          },\r\n        });\r\n\r\n        // 中心点\r\n        group.addShape('circle', {\r\n          attrs: {\r\n            x: 0,\r\n            y: 0,\r\n            r: 3,\r\n            fill: color,\r\n          },\r\n        });\r\n\r\n        return group;\r\n      },\r\n      setState(name: string, value: any, item: any) {\r\n        const group = item.getContainer();\r\n        const shape = group.getChildren()[0];\r\n\r\n        if (name === 'highlighted') {\r\n          if (value) {\r\n            shape.attr('r', 15);\r\n            shape.attr('lineWidth', 3);\r\n          } else {\r\n            shape.attr('r', 10);\r\n            shape.attr('lineWidth', 2);\r\n          }\r\n        } else if (name === 'selected') {\r\n          if (value) {\r\n            shape.attr('fill', '#722ed1');\r\n            shape.attr('fillOpacity', 0.3);\r\n          } else {\r\n            shape.attr('fill', '#fff');\r\n            shape.attr('fillOpacity', 1);\r\n          }\r\n        }\r\n      },\r\n    });\r\n  }\r\n\r\n  const width = container.clientWidth || 800;\r\n  const height = container.clientHeight || 600;\r\n\r\n  const graph = new (G6 as any).Graph({\r\n    container,\r\n    width,\r\n    height,\r\n    renderer: 'canvas' as any,\r\n    autoPaint: true,\r\n    modes: {\r\n      default: [\r\n        'drag-canvas',\r\n        'zoom-canvas',\r\n        'drag-node',\r\n        {\r\n          type: 'click-select',\r\n          formatIds: (ids: string[]) => ids,\r\n          onSelect: (selectedIds: string[]) => {\r\n            // 处理节点选中\r\n          },\r\n        },\r\n      ],\r\n    },\r\n    layout: {\r\n      type: 'force',\r\n      preventOverlap: true,\r\n      nodeSpacing: 50,\r\n      damping: 0.999,\r\n      maxIteration: 1000,\r\n      gravitationalConstant: -35,\r\n    },\r\n  });\r\n\r\n  graph.data(data);\r\n  graph.render();\r\n\r\n  return graph;\r\n}\r\n\r\n/**\r\n * 绑定图的交互事件\r\n */\r\nfunction bindInteractions(graph: G6.Graph, hyperEdges: HyperEdge[]) {\r\n  // 节点点击事件\r\n  graph.on('node:click', (ev: any) => {\r\n    const node = ev.item;\r\n    const nodeId = node.getID();\r\n\r\n    // 切换选中状态\r\n    if (node.hasState('selected')) {\r\n      (graph as any).setItemState(node, 'selected', false);\r\n    } else {\r\n      (graph as any).setItemState(node, 'selected', true);\r\n    }\r\n\r\n    // 检查是否是超边，如果是则高亮相关节点\r\n    const hyperEdge = hyperEdges.find((he) => he.id === nodeId);\r\n    if (hyperEdge) {\r\n      hyperEdge.nodes.forEach((targetId) => {\r\n        const targetNode = (graph as any).findById(targetId);\r\n        if (targetNode) {\r\n          (graph as any).setItemState(targetNode, 'highlighted', true);\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  // 节点鼠标悬停\r\n  graph.on('node:mouseenter', (ev: any) => {\r\n    const node = ev.item;\r\n    (graph as any).setItemState(node, 'highlighted', true);\r\n  });\r\n\r\n  // 节点鼠标离开\r\n  graph.on('node:mouseleave', (ev: any) => {\r\n    const node = ev.item;\r\n    if (!node.hasState('selected')) {\r\n      (graph as any).setItemState(node, 'highlighted', false);\r\n    }\r\n  });\r\n\r\n  // 双击展开相邻节点\r\n  graph.on('node:dblclick', (ev: any) => {\r\n    const node = ev.item;\r\n    const neighbors = (graph as any).getNeighbors(node);\r\n    neighbors.forEach((neighbor: any) => {\r\n      (graph as any).setItemState(neighbor, 'highlighted', true);\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * 高亮搜索结果\r\n */\r\nfunction highlightSearchResults(graph: any, resultIds: string[]) {\r\n  const resultSet = new Set(resultIds);\r\n\r\n  // 获取所有节点\r\n  (graph as any).getNodes().forEach((node: any) => {\r\n    const nodeId = node.getID();\r\n    if (resultSet.has(nodeId)) {\r\n      (graph as any).setItemState(node, 'highlighted', true);\r\n    } else {\r\n      (graph as any).setItemState(node, 'highlighted', false);\r\n    }\r\n  });\r\n\r\n  // 如果有结果，缩放到第一个结果\r\n  if (resultIds.length > 0) {\r\n    (graph as any).focusItem(resultIds[0], true, {\r\n      duration: 500,\r\n      easing: 'easeCubic',\r\n    });\r\n  }\r\n}\r\n\r\nexport default HypergraphView;\r\n"],"names":["HypergraphView","canvasRef","useRef","graphRef","data","selectedNodes","useVisualization","searchResults","useSearch","useEffect","message","hyperEdges","transformedData","transformDataToHypergraph","createGraph","bindInteractions","highlightSearchResults","error","jsx","virtualNodes","virtualEdges","edgesBySource","edge","index","targets","source","hyperedgeId","hyperEdge","target","container","G6.registered","G6.register","cfg","group","color","name","value","item","shape","width","height","graph","G6.Graph","ids","selectedIds","ev","node","nodeId","he","targetId","targetNode","neighbor","resultIds","resultSet"],"mappings":"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"}