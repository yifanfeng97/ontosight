import{r as u,u as N,a as D,b as L,j as R}from"./index-MwAwkXWd.js";import{G as W,N as v,E as x,C as z}from"./preset-pCXyFRGM.js";function H(C){const c=new Map;return C.forEach(a=>{const i=a.source<a.target?`${a.source}|${a.target}`:`${a.target}|${a.source}`;c.has(i)||c.set(i,[]),c.get(i).push(a)}),c.forEach(a=>{if(a.length===1)a[0].type="line",a[0].style={...a[0].style,curveOffset:0};else{const i=(a.length-1)/2;a.forEach((t,f)=>{t.type="quadratic",t.style={...t.style,curveOffset:(f-i)*30}})}}),C}const B=u.memo(function({data:c,meta:a}){const i=u.useRef(null),t=u.useRef(null),f=u.useRef(new Map),{selectedItems:w,selectItem:p,deselectItem:d,clearSelection:y,resetTrigger:S}=N(),{results:E}=D(),{addToast:m}=L();u.useEffect(()=>{f.current=w},[w]);const G=u.useCallback(e=>{var s;const r=(s=e.target)==null?void 0:s.id;r&&(f.current.has(r)?d(r):p(r,"node"))},[p,d]),b=u.useCallback(e=>{var s;const r=(s=e.target)==null?void 0:s.id;r&&(f.current.has(r)?d(r):p(r,"edge"))},[p,d]),I=u.useCallback(()=>{y()},[y]);u.useCallback(()=>{},[]);const k=u.useCallback(e=>{e.key==="Escape"?y():(e.ctrlKey||e.metaKey)&&e.key==="f"?(e.preventDefault(),m("搜索面板已激活","info")):e.key==="Delete"&&f.current.size>0&&(f.current.forEach(r=>{d(r.id)}),m("已清除选中项","success"))},[y,d,m]),V=u.useCallback(e=>{if(e)try{const r=e.getNodeData()||[],s=new Set(E);r.forEach(h=>{const l=h.id;if(s.has(l))e.setElementState(l,["highlight"]);else{const o=(e.getElementState(l)||[]).filter(g=>g!=="highlight");e.setElementState(l,o)}}),E.length>0&&e.focusElement(E[0])}catch(r){console.warn("[GraphView] Error in highlightSearchResults:",r)}},[E]);return u.useEffect(()=>{if(!(!i.current||!(c!=null&&c.nodes))){if(t.current){try{t.current.destroy()}catch(e){console.warn("[GraphView] Error destroying previous graph:",e)}t.current=null}try{const e=new W({container:i.current,width:i.current.clientWidth,height:i.current.clientHeight,layout:{type:"force",collide:{radius:n=>n.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:n=>{var o;return((o=n.data)==null?void 0:o.label)||n.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:n=>{var o;return((o=n.data)==null?void 0:o.label)||""},fontSize:10},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:c.nodes,edges:H(c.edges||[])}}),r=G,s=b,h=I;e.on(v.CLICK,r),e.on(x.CLICK,s),e.on(z.CLICK,h),e.on(v.DBLCLICK,n=>{var o;try{const g=(o=n.target)==null?void 0:o.id;if(!g)return;(e.getNeighborNodesData(g)||[]).forEach(K=>{e.setElementState(K.id,["highlight"])})}catch(g){console.warn("[GraphView] Error in dblclick handler:",g)}}),e.render().then(()=>{console.log("[GraphView] Graph rendered successfully"),V(e)}).catch(n=>{console.error("[GraphView] Error rendering graph:",n)});const l=()=>{if(i.current&&t.current)try{t.current.resize(i.current.clientWidth,i.current.clientHeight)}catch(n){console.warn("[GraphView] Error resizing graph:",n)}};return window.addEventListener("resize",l),window.addEventListener("keydown",k),t.current=e,()=>{if(window.removeEventListener("resize",l),window.removeEventListener("keydown",k),t.current)try{t.current.off(v.CLICK,r),t.current.off(x.CLICK,s),t.current.off(z.CLICK,h),t.current.destroy(),t.current=null}catch(n){console.warn("[GraphView] Error in cleanup:",n)}}}catch(e){return console.error("[GraphView] Error creating graph:",e),()=>{}}}},[c,G,b,I,k,V]),u.useEffect(()=>{if(!t.current||S===0)return;(async()=>{var r,s;try{console.log("[GraphView] Relayouting graph..."),(r=t.current)==null||r.stopLayout(),await((s=t.current)==null?void 0:s.layout()),console.log("[GraphView] Relayout completed")}catch(h){console.warn("[GraphView] Error relayouting graph on reset:",h)}})()},[S]),u.useEffect(()=>{if(!t.current||!c)return;(async()=>{var r,s,h;try{(r=c.nodes)==null||r.forEach(l=>{var o;const n=w.has(l.id);(o=t.current)==null||o.updateNodeData([{id:l.id,style:{fill:n?"#1890ff":"#87d068",lineWidth:n?3:1,stroke:n?"#1890ff":"#666"}}])}),(s=c.edges)==null||s.forEach(l=>{var o;const n=w.has(l.id);(o=t.current)==null||o.updateEdgeData([{id:l.id,style:{stroke:n?"#1890ff":"#ccc",lineWidth:n?2:1}}])}),await((h=t.current)==null?void 0:h.draw())}catch(l){console.warn("[GraphView] Error updating selection styles:",l)}})()},[w,c]),R.jsx("div",{className:"w-full h-full flex flex-col overflow-hidden",children:R.jsx("div",{ref:i,className:"graph-view flex-1"})})});export{B as default};
//# sourceMappingURL=GraphView-B2ORp9E0.js.map
