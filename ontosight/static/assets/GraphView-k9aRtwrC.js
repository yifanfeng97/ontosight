import{r as c,u as $,a as T,j as V}from"./index-gxuAEot_.js";import{s as z,G as K,N as g,C as D}from"./preset-CpxvkwU5.js";import"./asyncToGenerator-gDzglO_5.js";function M(k){const s=new Map;return k.forEach(l=>{const a=l.source<l.target?`${l.source}|${l.target}`:`${l.target}|${l.source}`;s.has(a)||s.set(a,[]),s.get(a).push(l)}),s.forEach(l=>{if(l.length===1)l[0].type="line",l[0].style={...l[0].style,curveOffset:0};else{const a=(l.length-1)/2;l.forEach((r,h)=>{r.type="quadratic",r.style={...r.style,curveOffset:(h-a)*30}})}}),k}const j=c.memo(function({data:s,meta:l}){const a=c.useRef(null),r=c.useRef(null),h=c.useRef(null),{selectedNodes:f,selectNode:G,deselectNode:v,clearSelection:m}=$(),{results:C}=T(),R=c.useCallback(n=>{var t;const o=(t=n.target)==null?void 0:t.id;o&&(f.has(o)?v(o):G(o))},[f,G,v]),b=c.useCallback(()=>{m()},[m]),S=c.useCallback(n=>{var t,p,d,E;const o=(t=n.target)==null?void 0:t.id;if(!(!o||!h.current||!r.current))try{const i=r.current.getNodeData(o);if(!i)return;const w=r.current.getElementPosition(o),[e,u]=w||[0,0],y=`
        <div class="graph-node-tooltip">
          <div class="tooltip-title">${((p=i.data)==null?void 0:p.label)||i.id}</div>
          <div class="tooltip-id">ID: ${i.id}</div>
          ${(d=i.data)!=null&&d.description?`<div class="tooltip-desc">${i.data.description}</div>`:""}
          ${((E=i.data)==null?void 0:E.value)!==void 0?`<div class="tooltip-value">Value: ${i.data.value}</div>`:""}
        </div>
      `;h.current.innerHTML=y,h.current.style.display="block",h.current.style.left=e+10+"px",h.current.style.top=u+10+"px"}catch(i){console.warn("[GraphView] Error in handleNodeMouseEnter:",i)}},[]),I=c.useCallback(()=>{h.current&&(h.current.style.display="none")},[]),N=c.useCallback(n=>{n.key==="Escape"?m():(n.ctrlKey||n.metaKey)&&n.key==="f"?(n.preventDefault(),z.info("搜索面板已激活")):n.key==="Delete"&&f.size>0&&(f.forEach(o=>{v(o)}),z.success("已清除选中节点"))},[f,m,v]),x=c.useCallback(n=>{if(n)try{const o=n.getNodeData()||[],t=new Set(C);o.forEach(p=>{const d=p.id;if(t.has(d))n.setElementState(d,["highlight"]);else{const i=(n.getElementState(d)||[]).filter(w=>w!=="highlight");n.setElementState(d,i)}}),C.length>0&&n.focusElement(C[0])}catch(o){console.warn("[GraphView] Error in highlightSearchResults:",o)}},[C]);return c.useEffect(()=>{var n,o;if(console.log("[GraphView] useEffect triggered"),console.log("[GraphView] data:",s),console.log("[GraphView] data.nodes:",((n=s==null?void 0:s.nodes)==null?void 0:n.length)||0),console.log("[GraphView] data.edges:",((o=s==null?void 0:s.edges)==null?void 0:o.length)||0),!a.current||!(s!=null&&s.nodes)){console.warn("[GraphView] Missing containerRef or data.nodes");return}if(r.current){try{r.current.destroy()}catch(t){console.warn("[GraphView] Error destroying previous graph:",t)}r.current=null}try{const t=new K({container:a.current,width:a.current.clientWidth,height:a.current.clientHeight,layout:{type:"force",collide:{radius:e=>e.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:e=>{var u;return((u=e.data)==null?void 0:u.label)||e.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:e=>{var u;return((u=e.data)==null?void 0:u.label)||""},fontSize:10},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:s.nodes.map(e=>({...e,style:{...e.style,fill:f.has(e.id)?"#1890ff":"#87d068",lineWidth:f.has(e.id)?3:1,stroke:f.has(e.id)?"#1890ff":"#666"}})),edges:M((s.edges||[]).map(e=>({...e,style:{stroke:"#ccc",lineWidth:1,...e.style}})))}}),p=R,d=b,E=S,i=I;t.on(g.CLICK,p),t.on(D.CLICK,d),t.on(g.POINTER_ENTER,E),t.on(g.POINTER_LEAVE,i),t.on(g.DBLCLICK,e=>{var u;try{const y=(u=e.target)==null?void 0:u.id;if(!y)return;(t.getNeighborNodesData(y)||[]).forEach(L=>{t.setElementState(L.id,["highlight"])})}catch(y){console.warn("[GraphView] Error in dblclick handler:",y)}}),t.render().then(()=>{console.log("[GraphView] Graph rendered successfully"),x(t)}).catch(e=>{console.error("[GraphView] Error rendering graph:",e)});const w=()=>{if(a.current&&r.current)try{r.current.resize(a.current.clientWidth,a.current.clientHeight)}catch(e){console.warn("[GraphView] Error resizing graph:",e)}};return window.addEventListener("resize",w),window.addEventListener("keydown",N),r.current=t,()=>{if(window.removeEventListener("resize",w),window.removeEventListener("keydown",N),r.current)try{r.current.off(g.CLICK,p),r.current.off(D.CLICK,d),r.current.off(g.POINTER_ENTER,E),r.current.off(g.POINTER_LEAVE,i),r.current.destroy(),r.current=null}catch(e){console.warn("[GraphView] Error in cleanup:",e)}}}catch(t){return console.error("[GraphView] Error creating graph:",t),()=>{}}},[s,f,R,b,S,I,N,x]),V.jsxs("div",{style:{position:"relative",width:"100%",height:"100%"},children:[V.jsx("div",{ref:a,className:"graph-view"}),V.jsx("div",{ref:h,className:"graph-tooltip",style:{display:"none"}})]})});export{j as default};
//# sourceMappingURL=GraphView-k9aRtwrC.js.map
