{"version":3,"file":"GraphView-BhqoUyfF.js","sources":["../../../frontend/src/components/views/GraphView.tsx"],"sourcesContent":["import { useEffect, useRef, useCallback, memo } from \"react\";\nimport * as G6 from \"@antv/g6\";\nimport { useVisualization } from \"@/hooks/useVisualization\";\nimport { useSearch } from \"@/hooks/useSearch\";\nimport { Tooltip, message } from \"antd\";\nimport \"@/components/views/GraphView.css\";\n\ninterface GraphViewProps {\n  data: any;\n  meta: any;\n}\n\nconst GraphView = memo(function GraphView({ data, meta }: GraphViewProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const graphRef = useRef<any>(null);\n  const tooltipRef = useRef<HTMLDivElement>(null);\n  const { selectedNodes, selectNode, deselectNode, clearSelection } = useVisualization();\n  const { results: searchResults } = useSearch();\n\n  const handleNodeClick = useCallback(\n    (evt: any) => {\n      const nodeModel = evt.item;\n      if (!nodeModel) return;\n\n      const nodeId = nodeModel.get(\"id\");\n      if (selectedNodes.has(nodeId)) {\n        deselectNode(nodeId);\n      } else {\n        selectNode(nodeId);\n      }\n    },\n    [selectedNodes, selectNode, deselectNode]\n  );\n\n  const handleCanvasClick = useCallback(() => {\n    clearSelection();\n  }, [clearSelection]);\n\n  // 处理节点悬停时的 Tooltip\n  const handleNodeMouseEnter = useCallback((evt: any) => {\n    const nodeModel = evt.item;\n    if (!nodeModel || !tooltipRef.current) return;\n\n    const nodeData = nodeModel.getModel();\n    const { x, y } = nodeModel.getModel();\n    \n    // 构建 Tooltip 内容\n    const content = `\n      <div class=\"graph-node-tooltip\">\n        <div class=\"tooltip-title\">${nodeData.label || nodeData.id}</div>\n        <div class=\"tooltip-id\">ID: ${nodeData.id}</div>\n        ${nodeData.description ? `<div class=\"tooltip-desc\">${nodeData.description}</div>` : ''}\n        ${nodeData.value !== undefined ? `<div class=\"tooltip-value\">Value: ${nodeData.value}</div>` : ''}\n      </div>\n    `;\n\n    tooltipRef.current.innerHTML = content;\n    tooltipRef.current.style.display = 'block';\n    tooltipRef.current.style.left = (x ?? 0) + 10 + 'px';\n    tooltipRef.current.style.top = (y ?? 0) + 10 + 'px';\n  }, []);\n\n  const handleNodeMouseLeave = useCallback(() => {\n    if (tooltipRef.current) {\n      tooltipRef.current.style.display = 'none';\n    }\n  }, []);\n\n  // 键盘快捷键处理\n  const handleKeyDown = useCallback((evt: KeyboardEvent) => {\n    if (evt.key === 'Escape') {\n      clearSelection();\n    } else if ((evt.ctrlKey || evt.metaKey) && evt.key === 'f') {\n      evt.preventDefault();\n      message.info('搜索面板已激活');\n    } else if (evt.key === 'Delete' && selectedNodes.size > 0) {\n      selectedNodes.forEach((nodeId) => {\n        deselectNode(nodeId);\n      });\n      message.success('已清除选中节点');\n    }\n  }, [selectedNodes, clearSelection, deselectNode]);\n\n  // 高亮搜索结果\n  const highlightSearchResults = useCallback((graph: any) => {\n    if (!graph) return;\n\n    const allNodes = (graph as any).getNodes();\n    const searchResultSet = new Set(searchResults);\n\n    allNodes.forEach((node: any) => {\n      const nodeId = node.getID();\n      if (searchResultSet.has(nodeId)) {\n        node.toFront();\n        (graph as any).setItemState(node, 'highlight', true);\n      } else {\n        (graph as any).setItemState(node, 'highlight', false);\n      }\n    });\n\n    // 如果有搜索结果，聚焦到第一个\n    if (searchResults.length > 0) {\n      const firstResult = (graph as any).findById(searchResults[0]);\n      if (firstResult) {\n        (graph as any).focusItem(firstResult, true);\n      }\n    }\n  }, [searchResults]);\n\n  useEffect(() => {\n    console.log(\"[GraphView] useEffect triggered\");\n    console.log(\"[GraphView] data:\", data);\n    console.log(\"[GraphView] data.nodes:\", data?.nodes?.length || 0);\n    console.log(\"[GraphView] data.edges:\", data?.edges?.length || 0);\n    \n    if (!containerRef.current || !data?.nodes) {\n      console.warn(\"[GraphView] Missing containerRef or data.nodes\");\n      return;\n    }\n\n    // Clean up old graph\n    if (graphRef.current) {\n      graphRef.current.destroy();\n    }\n\n    // Create new graph with state styles and data\n    const graph = new (G6 as any).Graph({\n      container: containerRef.current,\n      width: containerRef.current.clientWidth,\n      height: containerRef.current.clientHeight,\n      modes: {\n        default: [\"drag-canvas\", \"zoom-canvas\", \"drag-node\"],\n      },\n      nodeStateStyles: {\n        highlight: {\n          fill: '#ffd666',\n          stroke: '#faad14',\n          lineWidth: 2,\n          shadowColor: '#faad14',\n          shadowBlur: 10,\n        },\n        selected: {\n          fill: '#1890ff',\n          stroke: '#1890ff',\n          lineWidth: 3,\n          shadowColor: '#1890ff',\n          shadowBlur: 10,\n        },\n      },\n      edgeStateStyles: {\n        highlight: {\n          stroke: '#faad14',\n          lineWidth: 2,\n          opacity: 1,\n        },\n      },\n      data: {\n        nodes: data.nodes.map((node: any) => ({\n          ...node,\n          size: 30,\n          style: {\n            fill: selectedNodes.has(node.id) ? \"#1890ff\" : \"#87d068\",\n            lineWidth: selectedNodes.has(node.id) ? 3 : 1,\n            stroke: selectedNodes.has(node.id) ? \"#1890ff\" : \"#666\",\n          },\n        })),\n        edges: (data.edges || []).map((edge: any) => ({\n          ...edge,\n          style: {\n            stroke: '#ccc',\n            lineWidth: 1,\n          },\n        })),\n      },\n    });\n\n    // Event handlers\n    graph.on(\"node:click\", handleNodeClick);\n    graph.on(\"canvas:click\", handleCanvasClick);\n    graph.on(\"node:mouseenter\", handleNodeMouseEnter);\n    graph.on(\"node:mouseleave\", handleNodeMouseLeave);\n\n    // 双击节点展开相邻节点\n    graph.on(\"node:dblclick\", (evt: any) => {\n      const nodeModel = evt.item;\n      if (!nodeModel) return;\n      const neighbors = (graph as any).getNeighbors(nodeModel);\n      neighbors.forEach((neighbor: any) => {\n        (graph as any).setItemState(neighbor, 'highlight', true);\n      });\n    });\n\n    // Render\n    graph.render();\n\n    // 应用搜索高亮\n    highlightSearchResults(graph);\n\n    // Handle resize\n    const handleResize = () => {\n      if (containerRef.current) {\n        (graph as any).changeSize(\n          containerRef.current.clientWidth,\n          containerRef.current.clientHeight\n        );\n      }\n    };\n\n    window.addEventListener(\"resize\", handleResize);\n    window.addEventListener(\"keydown\", handleKeyDown);\n    graphRef.current = graph;\n\n    return () => {\n      window.removeEventListener(\"resize\", handleResize);\n      window.removeEventListener(\"keydown\", handleKeyDown);\n      graph.destroy();\n    };\n  }, [data, selectedNodes, handleNodeClick, handleCanvasClick, handleNodeMouseEnter, handleNodeMouseLeave, handleKeyDown, highlightSearchResults]);\n\n  return (\n    <div style={{ position: 'relative', width: '100%', height: '100%' }}>\n      <div ref={containerRef} className=\"graph-view\" />\n      <div\n        ref={tooltipRef}\n        className=\"graph-tooltip\"\n        style={{ display: 'none' }}\n      />\n    </div>\n  );\n});\n\nexport default GraphView;\n"],"names":["GraphView","memo","data","meta","containerRef","useRef","graphRef","tooltipRef","selectedNodes","selectNode","deselectNode","clearSelection","useVisualization","searchResults","useSearch","handleNodeClick","useCallback","evt","nodeModel","nodeId","handleCanvasClick","handleNodeMouseEnter","nodeData","x","y","content","handleNodeMouseLeave","handleKeyDown","message","highlightSearchResults","graph","allNodes","searchResultSet","node","firstResult","useEffect","_a","_b","G6.Graph","edge","neighbor","handleResize","jsxs","jsx"],"mappings":"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"}