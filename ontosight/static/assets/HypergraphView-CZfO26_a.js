import{r as a,u as I,b as L,d as W,j as z}from"./index-yaVI2luG.js";const B=[{fill:"#1890FF",stroke:"#0050B3"},{fill:"#52C41A",stroke:"#274704"},{fill:"#FA8C16",stroke:"#872000"},{fill:"#EB2F96",stroke:"#780C56"},{fill:"#13C2C2",stroke:"#0C464C"},{fill:"#722ED1",stroke:"#38165F"},{fill:"#F5222D",stroke:"#7F0000"},{fill:"#FA541C",stroke:"#7F2C00"},{fill:"#FFC53D",stroke:"#7F6400"},{fill:"#45B39D",stroke:"#0F5C4C"}];function _(V){return B[V%B.length]}const N={fill:"#1890ff",stroke:"#0050b3"},j=a.memo(function({data:i,meta:G}){const d=a.useRef(null),s=a.useRef(null),p=a.useRef(new Map),E=a.useRef(new Map),m=a.useRef(new Map),{selectedItems:h,selectItem:y,deselectItem:D,clearSelection:C,resetTrigger:T}=I(),{results:w}=L(),{addToast:S}=W();a.useEffect(()=>{m.current=h},[h]);const v=a.useCallback(t=>{var u;const n=(u=t.target)==null?void 0:u.id;n&&y(n,"node")},[y]),b=a.useCallback(t=>{y(t,"hyperedge")},[y]),H=a.useCallback(t=>{t.key==="Escape"?C():(t.ctrlKey||t.metaKey)&&t.key==="f"?(t.preventDefault(),S("搜索面板已激活","info")):t.key==="Delete"&&m.current.size>0&&(m.current.forEach(n=>{D(n.id)}),S("已清除选中项","success"))},[C,D,S]),k=a.useCallback(t=>{if(t)try{const n=t.getNodeData()||[],u=new Set(w);n.forEach(f=>{const e=f.id;if(u.has(e))t.setElementState(e,["highlight"]);else{const o=(t.getElementState(e)||[]).filter(l=>l!=="highlight");t.setElementState(e,o)}}),w.length>0&&t.focusElement(w[0])}catch(n){console.warn("[HypergraphView] Error in highlightSearchResults:",n)}},[w]);return a.useEffect(()=>{if(!(!d.current||!(i!=null&&i.nodes)||!window.G6)){if(s.current){try{s.current.destroy()}catch(t){console.warn("[HypergraphView] Error destroying previous graph:",t)}s.current=null}try{p.current.clear(),E.current.clear();const t=(i.hyperedges||[]).map((e,r)=>{const o=_(r);p.current.set(e.id,e),E.current.set(e.id,o);const l=h.has(e.id),c=l?N:o;return{key:`bubble-sets-${e.id}`,type:"bubble-sets",members:e.linked_nodes,fill:c.fill,fillOpacity:l?.3:.1,stroke:c.stroke,strokeOpacity:l?1:.6,label:!1,hyperedge:e}}),n=new window.G6.Graph({container:d.current,width:d.current.clientWidth,height:d.current.clientHeight,layout:{type:"force",collide:{radius:e=>e.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:e=>{var r;return((r=e.data)==null?void 0:r.label)||e.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:e=>{var r;return((r=e.data)==null?void 0:r.label)||""},fontSize:10,stroke:"#B4E5FF",opacity:.6},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:i.nodes.map(e=>{const r=h.has(e.id);return{...e,style:{...e.style,fill:r?"#1890ff":"#87d068",lineWidth:r?3:1,stroke:r?"#1890ff":"#666"}}}),edges:(i.edges||[]).map(e=>({...e,style:{stroke:"transparent",lineWidth:0,opacity:0,...e.style}}))},plugins:t,autoFit:"center"});n.on("node:click",v);const u=e=>{var r,o,l;if(e.targetType==="bubble-sets"){const c=((r=e.target)==null?void 0:r.options)||e.target;if(console.log("[HypergraphView] Bubble-sets event:",c),c){if((o=c.hyperedge)!=null&&o.id)return b(c.hyperedge.id),!0;const g=(l=c.key)==null?void 0:l.replace("bubble-sets-","");if(g&&p.current.has(g))return b(g),!0;for(const[R,F]of p.current.entries()){const x=c.members||[];if(F.node_set&&x.length===F.node_set.length&&x.every(O=>F.node_set.includes(O)))return b(R),!0}}}return!1};n.on("click",e=>{if(console.log("[HypergraphView] Click event:",e.targetType,e.target),!u(e)&&e.targetType!=="node"&&e.targetType==="canvas"){C();return}}),n.on("pointerdown",e=>{e.targetType==="bubble-sets"&&(console.log("[HypergraphView] Pointerdown on bubble-sets:",e.target),u(e))}),n.on("pointermove",e=>{e.targetType==="bubble-sets"?d.current&&(d.current.style.cursor="pointer"):e.targetType==="canvas"&&d.current&&(d.current.style.cursor="default")}),n.on("node:dblclick",e=>{var r;try{const o=(r=e.target)==null?void 0:r.id;if(!o)return;(n.getNeighborNodesData(o)||[]).forEach(c=>{n.setElementState(c.id,["highlight"])})}catch(o){console.warn("[HypergraphView] Error in dblclick handler:",o)}}),n.render().then(()=>{console.log("[HypergraphView] Graph rendered successfully"),k(n)}).catch(e=>{console.error("[HypergraphView] Error rendering graph:",e)});const f=()=>{if(d.current&&s.current)try{s.current.resize(d.current.clientWidth,d.current.clientHeight)}catch(e){console.warn("[HypergraphView] Error resizing graph:",e)}};return window.addEventListener("resize",f),window.addEventListener("keydown",H),s.current=n,()=>{if(window.removeEventListener("resize",f),window.removeEventListener("keydown",H),s.current)try{s.current.destroy(),s.current=null}catch(e){console.warn("[HypergraphView] Error in cleanup:",e)}}}catch(t){return console.error("[HypergraphView] Error creating graph:",t),()=>{}}}},[i,v,b,H,k]),a.useEffect(()=>{if(!s.current||T===0)return;(async()=>{var n,u,f;try{console.log("[HypergraphView] Full re-render with cold-start layout..."),(n=s.current)==null||n.stopLayout();const e=i.nodes.map(({x:r,y:o,...l})=>l);(u=s.current)==null||u.setData({nodes:e,edges:i.edges||[]}),await((f=s.current)==null?void 0:f.render()),s.current&&k(s.current),console.log("[HypergraphView] Full re-render completed")}catch(e){console.warn("[HypergraphView] Error during full re-render:",e)}})()},[T,i,k]),a.useEffect(()=>{if(!s.current||!i)return;(async()=>{var n,u,f;try{(n=i.nodes)==null||n.forEach(e=>{var o;const r=h.has(e.id);(o=s.current)==null||o.updateNodeData([{id:e.id,style:{fill:r?"#1890ff":"#87d068",lineWidth:r?3:1,stroke:r?"#1890ff":"#666"}}])}),(u=i.hyperedges)==null||u.forEach(e=>{var g;const r=h.has(e.id),o=E.current.get(e.id);if(!o)return;const l=r?N:o,c=`bubble-sets-${e.id}`;try{(g=s.current)==null||g.updatePlugin({key:c,fill:l.fill,fillOpacity:r?.3:.1,stroke:l.stroke,strokeOpacity:r?1:.6,labelBackgroundFill:l.stroke})}catch(R){console.warn("[HypergraphView] Error updating plugin:",c,R)}}),await((f=s.current)==null?void 0:f.draw())}catch(e){console.warn("[HypergraphView] Error updating selection styles:",e)}})()},[h,i]),z.jsx("div",{className:"w-full h-full flex flex-col overflow-hidden",children:z.jsx("div",{ref:d,className:"hypergraph-view flex-1"})})});export{j as default};
//# sourceMappingURL=HypergraphView-CZfO26_a.js.map
