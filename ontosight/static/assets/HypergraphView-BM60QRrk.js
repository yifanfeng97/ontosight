import{r as c,u as O,b as I,j as x}from"./index-Djf0YLQL.js";const z=[{fill:"#1890FF",stroke:"#0050B3"},{fill:"#52C41A",stroke:"#274704"},{fill:"#FA8C16",stroke:"#872000"},{fill:"#EB2F96",stroke:"#780C56"},{fill:"#13C2C2",stroke:"#0C464C"},{fill:"#722ED1",stroke:"#38165F"},{fill:"#F5222D",stroke:"#7F0000"},{fill:"#FA541C",stroke:"#7F2C00"},{fill:"#FFC53D",stroke:"#7F6400"},{fill:"#45B39D",stroke:"#0F5C4C"}];function W(D){return z[D%z.length]}const N={fill:"#1890ff",stroke:"#0050b3"},L=c.memo(function({data:o,meta:A}){const u=c.useRef(null),l=c.useRef(null),y=c.useRef(new Map),F=c.useRef(new Map),m=c.useRef(new Map),{selectedItems:g,selectItem:w,deselectItem:R,clearSelection:C,resetTrigger:V}=O(),{addToast:H}=I();c.useEffect(()=>{m.current=g},[g]);const T=c.useCallback(n=>{var d;const t=(d=n.target)==null?void 0:d.id;t&&w(t,"node")},[w]),b=c.useCallback(n=>{w(n,"hyperedge")},[w]),S=c.useCallback(n=>{n.key==="Escape"?C():(n.ctrlKey||n.metaKey)&&n.key==="f"?(n.preventDefault(),H("搜索面板已激活","info")):n.key==="Delete"&&m.current.size>0&&(m.current.forEach(t=>{R(t.id)}),H("已清除选中项","success"))},[C,R,H]),k=c.useCallback(n=>{if(n)try{(n.getNodeData()||[]).forEach(d=>{const h=d.id;if(d.highlighted)n.setElementState(h,["highlight"]);else{const r=(n.getElementState(h)||[]).filter(s=>s!=="highlight");n.setElementState(h,r)}})}catch(t){console.warn("[HypergraphView] Error in highlightSearchResults:",t)}},[]);return c.useEffect(()=>{if(!(!u.current||!(o!=null&&o.nodes)||!window.G6)){if(l.current){try{l.current.destroy()}catch(n){console.warn("[HypergraphView] Error destroying previous graph:",n)}l.current=null}try{y.current.clear(),F.current.clear();const n=(o.hyperedges||[]).map((e,r)=>{const s=W(r);y.current.set(e.id,e),F.current.set(e.id,s);const a=g.has(e.id),i=e.highlighted===!0;let f=s;return i?f={fill:"#FFD700",stroke:"#FFA500"}:a&&(f=N),{key:`bubble-sets-${e.id}`,type:"bubble-sets",members:e.linked_nodes,fill:f.fill,fillOpacity:a||i?.3:.1,stroke:f.stroke,strokeOpacity:a||i?1:.6,label:!1,hyperedge:e}}),t=new window.G6.Graph({container:u.current,width:u.current.clientWidth,height:u.current.clientHeight,layout:{type:"force",collide:{radius:e=>e.size/2},preventOverlap:!0},behaviors:["drag-canvas","zoom-canvas","drag-element"],node:{style:{labelText:e=>{var r;return((r=e.data)==null?void 0:r.label)||e.id},fontSize:12},state:{highlight:{fill:"#ffd666",stroke:"#faad14",lineWidth:2,shadowColor:"#faad14",shadowBlur:10},selected:{fill:"#1890ff",stroke:"#1890ff",lineWidth:3,shadowColor:"#1890ff",shadowBlur:10}}},edge:{style:{labelText:e=>{var r;return((r=e.data)==null?void 0:r.label)||""},fontSize:10,stroke:"#B4E5FF",opacity:.6},state:{highlight:{stroke:"#faad14",lineWidth:2,opacity:1}}},data:{nodes:o.nodes.map(e=>{const r=g.has(e.id),s=e.highlighted===!0;return{...e,style:{...e.style,fill:s?"#FFD700":r?"#1890ff":"#87d068",lineWidth:r?3:s?2:1,stroke:s?"#FFA500":r?"#1890ff":"#666"}}}),edges:(o.edges||[]).map(e=>({...e,style:{stroke:"transparent",lineWidth:0,opacity:0,...e.style}}))},plugins:n,autoFit:"center"});t.on("node:click",T);const d=e=>{var r,s,a;if(e.targetType==="bubble-sets"){const i=((r=e.target)==null?void 0:r.options)||e.target;if(console.log("[HypergraphView] Bubble-sets event:",i),i){if((s=i.hyperedge)!=null&&s.id)return b(i.hyperedge.id),!0;const f=(a=i.key)==null?void 0:a.replace("bubble-sets-","");if(f&&y.current.has(f))return b(f),!0;for(const[E,p]of y.current.entries()){const v=i.members||[];if(p.node_set&&v.length===p.node_set.length&&v.every(B=>p.node_set.includes(B)))return b(E),!0}}}return!1};t.on("click",e=>{if(console.log("[HypergraphView] Click event:",e.targetType,e.target),!d(e)&&e.targetType!=="node"&&e.targetType==="canvas"){C();return}}),t.on("pointerdown",e=>{e.targetType==="bubble-sets"&&(console.log("[HypergraphView] Pointerdown on bubble-sets:",e.target),d(e))}),t.on("pointermove",e=>{e.targetType==="bubble-sets"?u.current&&(u.current.style.cursor="pointer"):e.targetType==="canvas"&&u.current&&(u.current.style.cursor="default")}),t.on("node:dblclick",e=>{var r;try{const s=(r=e.target)==null?void 0:r.id;if(!s)return;(t.getNeighborNodesData(s)||[]).forEach(i=>{t.setElementState(i.id,["highlight"])})}catch(s){console.warn("[HypergraphView] Error in dblclick handler:",s)}}),t.render().then(()=>{console.log("[HypergraphView] Graph rendered successfully"),k(t)}).catch(e=>{console.error("[HypergraphView] Error rendering graph:",e)});const h=()=>{if(u.current&&l.current)try{l.current.resize(u.current.clientWidth,u.current.clientHeight)}catch(e){console.warn("[HypergraphView] Error resizing graph:",e)}};return window.addEventListener("resize",h),window.addEventListener("keydown",S),l.current=t,()=>{if(window.removeEventListener("resize",h),window.removeEventListener("keydown",S),l.current)try{l.current.destroy(),l.current=null}catch(e){console.warn("[HypergraphView] Error in cleanup:",e)}}}catch(n){return console.error("[HypergraphView] Error creating graph:",n),()=>{}}}},[o,T,b,S,k]),c.useEffect(()=>{if(!l.current||V===0)return;(async()=>{try{if(!l.current){console.warn("[HypergraphView] Graph instance is null, skipping re-render");return}console.log("[HypergraphView] Full re-render with cold-start layout...");const t=o.nodes.map(({x:d,y:h,...e})=>e);l.current.setData({nodes:t,edges:o.edges||[]}),await l.current.render(),l.current&&k(l.current),console.log("[HypergraphView] Full re-render completed")}catch(t){console.warn("[HypergraphView] Error during full re-render:",t)}})()},[V,o,k]),c.useEffect(()=>{if(!l.current||!o)return;(async()=>{var t,d,h;try{(t=o.nodes)==null||t.forEach(e=>{var a;const r=g.has(e.id),s=e.highlighted===!0;(a=l.current)==null||a.updateNodeData([{id:e.id,style:{fill:s?"#FFD700":r?"#1890ff":"#87d068",lineWidth:r?3:s?2:1,stroke:s?"#FFA500":r?"#1890ff":"#666"}}])}),(d=o.hyperedges)==null||d.forEach(e=>{var E;const r=g.has(e.id),s=e.highlighted===!0,a=F.current.get(e.id);if(!a)return;let i=a;s?i={fill:"#FFD700",stroke:"#FFA500"}:r&&(i=N);const f=`bubble-sets-${e.id}`;try{(E=l.current)==null||E.updatePlugin({key:f,fill:i.fill,fillOpacity:r||s?.3:.1,stroke:i.stroke,strokeOpacity:r||s?1:.6,labelBackgroundFill:i.stroke})}catch(p){console.warn("[HypergraphView] Error updating plugin:",f,p)}}),await((h=l.current)==null?void 0:h.draw())}catch(e){console.warn("[HypergraphView] Error updating selection styles:",e)}})()},[g,o]),x.jsx("div",{className:"w-full h-full flex flex-col overflow-hidden",children:x.jsx("div",{ref:u,className:"hypergraph-view flex-1"})})});export{L as default};
//# sourceMappingURL=HypergraphView-BM60QRrk.js.map
